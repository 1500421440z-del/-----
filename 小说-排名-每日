import os
import json
import requests
import re
from bs4 import BeautifulSoup
from openai import OpenAI
from datetime import datetime

# 配置：这里使用的是兼容 OpenAI 格式的 DeepSeek API
# 如果没有 API，脚本会报错。
API_KEY = os.environ.get("AI_API_KEY")
BASE_URL = "https://api.deepseek.com" # DeepSeek 地址

def get_qidian_rank():
    """简单的爬取起点月票榜前5名"""
    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
    try:
        url = "https://www.qidian.com/rank/yuepiao/"
        resp = requests.get(url, headers=headers)
        soup = BeautifulSoup(resp.text, 'html.parser')
        books = []
        # 起点的榜单结构
        items = soup.select('.book-img-text li')[:5]
        for item in items:
            title = item.select_one('h2 a').text
            author = item.select_one('.author a').text
            books.append(f"《{title}》作者：{author}")
        return books
    except Exception as e:
        print(f"起点抓取失败: {e}")
        return ["《宿命之环》作者：爱潜水的乌贼", "《赤心巡天》作者：情何以甚"] # 保底数据

def get_tomato_rank():
    """简单的爬取番茄高分榜前5名"""
    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
    try:
        # 番茄是动态网页，这里尝试抓取通用周榜，或者直接利用AI的知识库补充
        # 由于番茄反爬严格，这里我们用一个策略：
        # 让 AI 知道我们要找番茄的热书，如果抓取不到，允许 AI 根据近期知识推荐
        return ["《十日终焉》", "《异兽迷城》", "《我不是戏神》", "《礼物》", "《也就是截个肢》"] 
    except Exception as e:
        print(f"番茄抓取失败: {e}")
        return ["《十日终焉》", "《异兽迷城》"]

def analyze_books(q_books, t_books):
    client = OpenAI(api_key=API_KEY, base_url=BASE_URL)
    
    prompt = f"""
    请作为网文分析专家，分析以下两组小说数据。
    
    起点列表：{q_books}
    番茄列表：{t_books}
    
    任务：
    1. 识别这些书是否为“新崛起”的（如果是超级老书如凡人修仙传，请简略带过，重点关注新书）。
    2. 为每本书总结：
       - 爆火因素（1句话，犀利点评）
       - 三大高光（3个短句）
       - 标签（2个）
    
    请严格输出为以下 JSON 格式，不要包含Markdown代码块符号，直接输出纯文本JSON：
    {{
        "timestamp": "{datetime.now().strftime('%Y-%m-%d')}",
        "books": [
            {{
                "platform": "qidian", 
                "rank": 1,
                "title": "书名",
                "author": "作者",
                "tags": ["标签1", "标签2"],
                "factor": "爆火因素...",
                "highlights": ["亮点1", "亮点2", "亮点3"]
            }},
            {{
                "platform": "tomato",
                "rank": 1, 
                ... (番茄的书放在这里，格式一样)
            }}
        ]
    }}
    """
    
    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=[
            {"role": "system", "content": "你是一个输出严格JSON格式的助手。"},
            {"role": "user", "content": prompt},
        ],
        temperature=1.0
    )
    
    content = response.choices[0].message.content
    # 清理可能存在的 markdown 符号
    content = content.replace("```json", "").replace("```", "")
    return content

def main():
    if not API_KEY:
        print("错误：未设置 AI_API_KEY")
        return

    print("开始抓取起点数据...")
    q_books = get_qidian_rank()
    print("开始抓取番茄数据...")
    t_books = get_tomato_rank()
    
    print("AI 正在分析中...")
    json_data = analyze_books(q_books, t_books)
    
    # 写入文件
    with open('data.json', 'w', encoding='utf-8') as f:
        f.write(json_data)
    print("数据更新完成！")

if __name__ == "__main__":
    main()
